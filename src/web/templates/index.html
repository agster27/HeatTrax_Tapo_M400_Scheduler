<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeatTrax Scheduler</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="header">
        <h1>üî• HeatTrax Scheduler</h1>
        <p>Weather-based automation for heated mats and smart devices</p>
    </div>

    <div id="setup-mode-banner" class="warning" style="display: none; background: #fff3cd; border-color: #ff9800;">
        <strong>üîß Setup Mode Active</strong><br>
        <p style="margin: 10px 0 0 0;">
            <span id="setup-reason"></span><br>
            <strong>Device control is currently DISABLED.</strong> The scheduler is running in safe mode.
            Please configure valid Tapo credentials below and restart to enable device control.
        </p>
    </div>

    <div id="security-warning" class="warning" style="display: none;">
        <strong>‚ö†Ô∏è Security Warning:</strong> Web UI is accessible over the network and authentication is disabled. 
        Do not expose this service directly to the internet.
    </div>

    <div class="tab-container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('status')">Status</button>
            <button class="tab" onclick="switchTab('schedules')">Schedules</button>
            <button class="tab" onclick="switchTab('groups')">Groups</button>
            <button class="tab" onclick="switchTab('config')">Configuration</button>
            <button class="tab" onclick="switchTab('health')">Health</button>
            <button class="tab" onclick="switchTab('weather')">Weather</button>
        </div>
    </div>

    <div id="status-tab" class="tab-content active">
        <div class="card" id="vacation-mode-card">
            <h2>üèñÔ∏è Vacation Mode</h2>
            <p>When enabled, all schedules are disabled and devices are turned off. Manual control still works.</p>
            <div style="display: flex; align-items: center; gap: 20px; margin-top: 15px;">
                <label class="vacation-toggle-switch">
                    <input type="checkbox" id="vacation-mode-toggle" onchange="toggleVacationMode(this.checked)">
                    <span class="vacation-toggle-slider">
                        <span class="vacation-toggle-text left">Disabled</span>
                        <span class="vacation-toggle-text right">Enabled</span>
                    </span>
                </label>
                <span id="vacation-mode-status" style="font-size: 18px; font-weight: 600;"></span>
            </div>
            <div id="vacation-mode-message" style="margin-top: 15px; display: none;"></div>
        </div>
        
        <div class="card">
            <h2>System Status</h2>
            <button onclick="refreshStatus()">üîÑ Refresh</button>
            <div id="status-content" class="status-grid">
                <div class="status-item">
                    <label>Loading...</label>
                </div>
            </div>
        </div>
        
        {% include 'notifications_panel.html' %}
        
        <div class="card">
            <h2>Configuration File Management</h2>
            <p>Download or upload your config.yaml file. Uploaded files will be validated before overwriting the current configuration.</p>
            <div class="button-group">
                <button onclick="downloadConfig()">üì• Download config.yaml</button>
                <button onclick="document.getElementById('config-upload-input').click()">üì§ Upload config.yaml</button>
                <input type="file" id="config-upload-input" accept=".yaml,.yml" style="display: none;" onchange="uploadConfig(this.files[0])">
            </div>
            <div id="config-upload-message"></div>
        </div>
    </div>

    <div id="schedules-tab" class="tab-content">
        <div class="card">
            <h2>Schedule Management</h2>
            <p>Manage schedules for all device groups. Schedules control when devices turn on and off based on time and weather conditions.</p>
            <button onclick="refreshSchedules()">üîÑ Refresh</button>
            <div id="schedules-content">
                <p>Loading schedules...</p>
            </div>
        </div>
        
        <div class="card" id="solar-times-card" style="display: none;">
            <h2>‚òÄÔ∏è Solar Times (Today)</h2>
            <div id="solar-times-content" class="status-grid">
                <p>Loading solar times...</p>
            </div>
        </div>
    </div>

    <div id="groups-tab" class="tab-content">
        <div class="card">
            <h2>Device Groups</h2>
            <p>Control automation settings for each device group. Changes apply immediately and override config.yaml values until cleared.</p>
            <button onclick="refreshGroups()">üîÑ Refresh</button>
            <div id="groups-content">
                <p>Loading groups...</p>
            </div>
        </div>
    </div>

    <div id="config-tab" class="tab-content">
        <div id="env-overrides-info"></div>
        <div class="card">
            <h2>Configuration Editor</h2>
            <p>Configure your HeatTrax Scheduler settings below. Fields marked as read-only are controlled by environment variables.</p>
            <form id="config-form">
                <!-- Form sections will be populated here -->
            </form>
            <div class="button-group">
                <button onclick="loadConfig()">üîÑ Reload</button>
                <button onclick="saveConfig()">üíæ Save Configuration</button>
            </div>
            <div id="config-message"></div>
        </div>
    </div>

    <div id="health-tab" class="tab-content">
        <div class="card">
            <h2>Health Summary</h2>
            <button onclick="refreshHealth()">üîÑ Refresh</button>
            <div id="health-summary" class="health-summary">
                <div class="health-summary-item">
                    <div class="value">-</div>
                    <div class="label">System Status</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Health Checks</h2>
            <div id="health-checks-content">
                <p>Loading health information...</p>
            </div>
        </div>
        
        <div class="card">
            <h2>Device Health</h2>
            <p>View device health status and manually control device outlets. Changes take effect immediately and override scheduled behavior until the next scheduled action.</p>
            
            <div class="view-toggle-container">
                <span class="view-toggle-label">View:</span>
                <label class="view-toggle-switch">
                    <input type="checkbox" id="health-view-toggle" onchange="switchHealthView(this.checked ? 'group' : 'device')">
                    <span class="view-toggle-slider">
                        <span class="view-toggle-text left">Device</span>
                        <span class="view-toggle-text right">Group</span>
                    </span>
                </label>
            </div>
            
            <div id="device-health-content">
                <div class="info-text empty">Loading...</div>
            </div>
        </div>
    </div>

    <div id="weather-tab" class="tab-content">
        <div class="card">
            <h2>Weather Summary</h2>
            <button onclick="refreshWeather()">üîÑ Refresh</button>
            <div id="weather-info" class="status-grid">
                <div class="status-item">
                    <label>Loading...</label>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Weather Forecast</h2>
            <div id="weather-forecast-table" style="overflow-x: auto;">
                <p>Loading forecast data...</p>
            </div>
        </div>
        
        <div class="card">
            <h2>Mat Activity Timeline</h2>
            <p>Predicted ON/OFF windows for each device group based on weather forecast and schedule.</p>
            <div id="weather-mat-timelines">
                <p>Loading mat predictions...</p>
            </div>
        </div>
    </div>

    <!-- Schedule Edit/Add Modal -->
    <div id="schedule-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="schedule-modal-title">Add Schedule</h2>
                <span class="modal-close" onclick="closeScheduleModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="schedule-form" onsubmit="return false;">
                    <div class="form-group">
                        <label for="schedule-name">Schedule Name</label>
                        <input type="text" id="schedule-name" placeholder="e.g., Morning Heating" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="schedule-priority">Priority</label>
                        <select id="schedule-priority">
                            <option value="critical">Critical (highest)</option>
                            <option value="normal" selected>Normal</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="schedule-enabled" checked>
                            Enabled
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>Days of Week</label>
                        <div class="days-selector">
                            <label class="day-checkbox"><input type="checkbox" value="1" checked> Mon</label>
                            <label class="day-checkbox"><input type="checkbox" value="2" checked> Tue</label>
                            <label class="day-checkbox"><input type="checkbox" value="3" checked> Wed</label>
                            <label class="day-checkbox"><input type="checkbox" value="4" checked> Thu</label>
                            <label class="day-checkbox"><input type="checkbox" value="5" checked> Fri</label>
                            <label class="day-checkbox"><input type="checkbox" value="6" checked> Sat</label>
                            <label class="day-checkbox"><input type="checkbox" value="7" checked> Sun</label>
                        </div>
                    </div>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>ON Time</h3>
                    <div class="form-group">
                        <label for="on-type">Time Type</label>
                        <select id="on-type" onchange="updateOnTimeFields()">
                            <option value="time">Fixed Time (HH:MM)</option>
                            <option value="sunrise">Sunrise</option>
                            <option value="sunset">Sunset</option>
                        </select>
                    </div>
                    
                    <div id="on-time-field" class="form-group">
                        <label for="on-time-value">Time (24-hour format)</label>
                        <input type="time" id="on-time-value" required>
                    </div>
                    
                    <div id="on-solar-fields" style="display: none;">
                        <div class="form-group">
                            <label for="on-offset">Offset (minutes)</label>
                            <input type="number" id="on-offset" value="0" min="-180" max="180" step="1">
                            <div class="helper-text">Positive = after sunrise/sunset, Negative = before</div>
                        </div>
                        <div class="form-group">
                            <label for="on-fallback">Fallback Time</label>
                            <input type="time" id="on-fallback">
                            <div class="helper-text">Used if solar calculation fails</div>
                        </div>
                    </div>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>OFF Time</h3>
                    <div class="form-group">
                        <label for="off-type">Time Type</label>
                        <select id="off-type" onchange="updateOffTimeFields()">
                            <option value="time">Fixed Time (HH:MM)</option>
                            <option value="sunrise">Sunrise</option>
                            <option value="sunset">Sunset</option>
                            <option value="duration">Duration (hours after ON)</option>
                        </select>
                    </div>
                    
                    <div id="off-time-field" class="form-group">
                        <label for="off-time-value">Time (24-hour format)</label>
                        <input type="time" id="off-time-value" required>
                    </div>
                    
                    <div id="off-solar-fields" style="display: none;">
                        <div class="form-group">
                            <label for="off-offset">Offset (minutes)</label>
                            <input type="number" id="off-offset" value="0" min="-180" max="180" step="1">
                            <div class="helper-text">Positive = after sunrise/sunset, Negative = before</div>
                        </div>
                        <div class="form-group">
                            <label for="off-fallback">Fallback Time</label>
                            <input type="time" id="off-fallback">
                            <div class="helper-text">Used if solar calculation fails</div>
                        </div>
                    </div>
                    
                    <div id="off-duration-field" style="display: none;" class="form-group">
                        <label for="off-duration">Duration (hours)</label>
                        <input type="number" id="off-duration" value="1" min="0.1" max="24" step="0.1">
                    </div>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>Conditions (Optional)</h3>
                    <div class="form-group">
                        <label for="condition-temp-max">Maximum Temperature (¬∞F)</label>
                        <input type="number" id="condition-temp-max" placeholder="e.g., 32" step="0.1">
                        <div class="helper-text">Only run if temperature is at or below this value</div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="condition-precip">
                            Only run when precipitation is active
                        </label>
                    </div>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>Safety Overrides (Optional)</h3>
                    <div class="form-group">
                        <label for="safety-max-runtime">Max Runtime (hours)</label>
                        <input type="number" id="safety-max-runtime" placeholder="Use global default" step="0.1" min="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="safety-cooldown">Cooldown (minutes)</label>
                        <input type="number" id="safety-cooldown" placeholder="Use global default" step="1" min="0">
                    </div>
                    
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeScheduleModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveSchedule()">Save Schedule</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>

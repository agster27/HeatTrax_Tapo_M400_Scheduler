# HeatTrax Tapo M400 Scheduler Configuration
#
# All settings can be overridden using environment variables with the HEATTRAX_ prefix.
# Environment variables take precedence over values in this file.
# This is useful for Docker deployments and keeping secrets secure.

# Location settings for weather data
# Environment variables: HEATTRAX_LATITUDE, HEATTRAX_LONGITUDE, HEATTRAX_TIMEZONE
location:
  latitude: 40.7128          # ENV: HEATTRAX_LATITUDE
  longitude: -74.0060        # ENV: HEATTRAX_LONGITUDE
  timezone: "America/New_York"  # ENV: HEATTRAX_TIMEZONE

# Weather API Configuration
# Supports both OpenWeatherMap and Open-Meteo APIs
weather_api:
  # Provider: 'openweathermap' or 'open-meteo' (default: open-meteo)
  provider: "open-meteo"  # ENV: HEATTRAX_WEATHER_PROVIDER
  
  # OpenWeatherMap settings (required if provider is 'openweathermap')
  openweathermap:
    api_key: "your_api_key_here"  # ENV: HEATTRAX_OPENWEATHERMAP_API_KEY
    # Optional: API endpoint (defaults to official API)
    # api_url: "https://api.openweathermap.org/data/2.5"
  
  # Open-Meteo settings (no API key required)
  # Open-Meteo is free and doesn't require an API key
  open_meteo:
    # Optional: API endpoint (defaults to official API)
    # api_url: "https://api.open-meteo.com/v1"

# Device Configuration
# Two modes supported:
# 1. Legacy mode: Single device (backward compatible)
# 2. Multi-device mode: Multiple devices with groups

# LEGACY MODE (backward compatible - single device)
# Uncomment this section to use single device mode
# device:
#   ip_address: "192.168.1.100"      # ENV: HEATTRAX_TAPO_IP_ADDRESS
#   username: "your_tapo_username"   # ENV: HEATTRAX_TAPO_USERNAME
#   password: "your_tapo_password"   # ENV: HEATTRAX_TAPO_PASSWORD

# MULTI-DEVICE MODE (supports groups and multiple outlets)
# Comment out the 'device:' section above and use 'devices:' section below
devices:
  # Global credentials for all Kasa/Tapo devices
  credentials:
    username: "your_tapo_username"   # ENV: HEATTRAX_TAPO_USERNAME
    password: "your_tapo_password"   # ENV: HEATTRAX_TAPO_PASSWORD
  
  # Device groups - organize devices by function
  groups:
    # Heated mats group - controlled by weather automation
    heated_mats:
      enabled: true
      # Automation rules for this group
      automation:
        # Weather-based control
        weather_control: true
        # Turn on before precipitation
        precipitation_control: true
        # Early morning black ice protection
        morning_mode: true
      
      # Devices in this group
      items:
        - name: "Front Walkway Mat"
          ip_address: "192.168.1.100"
          # For EP40M with 2 outlets, specify which outlets to control
          # If omitted, controls the entire plug
          outlets: [0, 1]  # Control both outlets
        
        - name: "Driveway Mat"
          ip_address: "192.168.1.101"
          outlets: [0]  # Control only first outlet
        
        - name: "Back Porch Mat"
          ip_address: "192.168.1.102"
          # No outlets specified = control entire device
    
    # Christmas lights group - schedule-based control
    christmas_lights:
      enabled: true
      # Automation rules for this group
      automation:
        # Weather-based control disabled for lights
        weather_control: false
        precipitation_control: false
        morning_mode: false
        # Schedule-based control
        schedule_control: true
      
      # Schedule for this group
      schedule:
        # Turn on at sunset or specific time
        on_time: "17:00"  # 5:00 PM
        # Turn off at specific time
        off_time: "23:00"  # 11:00 PM
        # Optional: Only run on specific days (0=Monday, 6=Sunday)
        # days: [5, 6]  # Saturday and Sunday only
      
      # Devices in this group
      items:
        - name: "Front Yard Lights"
          ip_address: "192.168.1.110"
          outlets: [0, 1]
        
        - name: "Tree Lights"
          ip_address: "192.168.1.111"

# Weather thresholds for heated mats
# Environment variables: HEATTRAX_THRESHOLD_TEMP_F, HEATTRAX_LEAD_TIME_MINUTES, HEATTRAX_TRAILING_TIME_MINUTES
thresholds:
  # Temperature threshold in Fahrenheit for icy conditions
  temperature_f: 34              # ENV: HEATTRAX_THRESHOLD_TEMP_F
  # Minutes before precipitation to turn on (anticipatory heating)
  lead_time_minutes: 60          # ENV: HEATTRAX_LEAD_TIME_MINUTES
  # Minutes after precipitation ends to keep heating (ensure drying)
  trailing_time_minutes: 60      # ENV: HEATTRAX_TRAILING_TIME_MINUTES

# Optional morning frost-clearing/black ice protection mode
# Environment variables: HEATTRAX_MORNING_MODE_ENABLED, HEATTRAX_MORNING_MODE_START_HOUR, HEATTRAX_MORNING_MODE_END_HOUR
morning_mode:
  enabled: true      # ENV: HEATTRAX_MORNING_MODE_ENABLED (true/false)
  start_hour: 6      # ENV: HEATTRAX_MORNING_MODE_START_HOUR (0-23)
  end_hour: 8        # ENV: HEATTRAX_MORNING_MODE_END_HOUR (0-23)
  # Temperature threshold for morning mode (can be different from main threshold)
  temperature_f: 32  # Activate if below this temp during morning window

# Safety settings
# Environment variables: HEATTRAX_MAX_RUNTIME_HOURS, HEATTRAX_COOLDOWN_MINUTES
safety:
  # Maximum continuous runtime in hours
  max_runtime_hours: 6       # ENV: HEATTRAX_MAX_RUNTIME_HOURS
  # Cooldown period after max runtime in minutes
  cooldown_minutes: 30       # ENV: HEATTRAX_COOLDOWN_MINUTES

# Scheduler settings
# Environment variables: HEATTRAX_CHECK_INTERVAL_MINUTES, HEATTRAX_FORECAST_HOURS
scheduler:
  # How often to check weather in minutes
  check_interval_minutes: 10   # ENV: HEATTRAX_CHECK_INTERVAL_MINUTES
  # How far ahead to look for precipitation in hours
  forecast_hours: 12           # ENV: HEATTRAX_FORECAST_HOURS

# Logging settings
# Environment variable: HEATTRAX_LOG_LEVEL
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL - ENV: HEATTRAX_LOG_LEVEL
  max_file_size_mb: 10
  backup_count: 5

# Health check settings - periodic device monitoring
# Environment variables: HEATTRAX_HEALTH_CHECK_INTERVAL_HOURS, HEATTRAX_HEALTH_CHECK_MAX_FAILURES
health_check:
  interval_hours: 24  # How often to run health checks (ENV: HEATTRAX_HEALTH_CHECK_INTERVAL_HOURS)
  max_consecutive_failures: 3  # Max failures before triggering re-init (ENV: HEATTRAX_HEALTH_CHECK_MAX_FAILURES)

# Reboot settings - pause before container restart
# Environment variable: HEATTRAX_REBOOT_PAUSE_SECONDS
reboot:
  pause_seconds: 60  # Pause duration (in seconds) before container restart on critical failures (ENV: HEATTRAX_REBOOT_PAUSE_SECONDS)
                     # This allows time for console troubleshooting before automatic restart
                     # Set to 0 to disable the pause

# Notification settings - alerts for device issues (default: all disabled)
# Email notifications - Environment variables: HEATTRAX_NOTIFICATION_EMAIL_*
notifications:
  email:
    enabled: false  # ENV: HEATTRAX_NOTIFICATION_EMAIL_ENABLED (true/false)
    smtp_host: "smtp.gmail.com"  # ENV: HEATTRAX_NOTIFICATION_EMAIL_SMTP_HOST
    smtp_port: 587  # ENV: HEATTRAX_NOTIFICATION_EMAIL_SMTP_PORT
    smtp_username: "your_email@gmail.com"  # ENV: HEATTRAX_NOTIFICATION_EMAIL_SMTP_USERNAME
    smtp_password: "your_app_password"  # ENV: HEATTRAX_NOTIFICATION_EMAIL_SMTP_PASSWORD
    from_email: "your_email@gmail.com"  # ENV: HEATTRAX_NOTIFICATION_EMAIL_FROM
    to_emails:  # ENV: HEATTRAX_NOTIFICATION_EMAIL_TO (comma-separated)
      - "recipient1@example.com"
      - "recipient2@example.com"
    use_tls: true  # ENV: HEATTRAX_NOTIFICATION_EMAIL_USE_TLS (true/false)
  
  # Webhook notifications - Environment variables: HEATTRAX_NOTIFICATION_WEBHOOK_*
  webhook:
    enabled: false  # ENV: HEATTRAX_NOTIFICATION_WEBHOOK_ENABLED (true/false)
    url: "https://your-webhook-url.com/notifications"  # ENV: HEATTRAX_NOTIFICATION_WEBHOOK_URL
    # Optional custom headers can be added here

# Additional environment variables:
# - HEATTRAX_CONFIG_PATH: Path to this configuration file (default: config.yaml)
# - TZ: System timezone (e.g., America/New_York)

# Notification Events:
# - device_lost: Configured device not found during health check
# - device_found: New device discovered
# - device_changed: Device alias or properties changed
# - device_ip_changed: Device MAC/IP mapping changed (critical)
# - connectivity_lost: Failed to reinitialize device connection
# - connectivity_restored: Device connection restored after failures

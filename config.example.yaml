# HeatTrax Tapo M400 Scheduler Configuration
#
# All settings can be overridden using environment variables with the HEATTRAX_ prefix.
# Environment variables take precedence over values in this file.
# This is useful for Docker deployments and keeping secrets secure.

# Location settings for weather data
# Environment variables: HEATTRAX_LATITUDE, HEATTRAX_LONGITUDE, HEATTRAX_TIMEZONE
location:
  latitude: 40.7128          # ENV: HEATTRAX_LATITUDE
  longitude: -74.0060        # ENV: HEATTRAX_LONGITUDE
  timezone: "America/New_York"  # ENV: HEATTRAX_TIMEZONE

# Weather API Configuration
# Supports both OpenWeatherMap and Open-Meteo APIs
weather_api:
  # Enable/disable weather-based scheduling (default: true)
  # When disabled, uses fixed schedule behavior instead of weather forecasts
  enabled: true  # ENV: HEATTRAX_WEATHER_ENABLED
  
  # Provider: 'openweathermap' or 'open-meteo' (default: open-meteo)
  provider: "open-meteo"  # ENV: HEATTRAX_WEATHER_PROVIDER
  
  # OpenWeatherMap settings (required if provider is 'openweathermap')
  openweathermap:
    api_key: "your_api_key_here"  # ENV: HEATTRAX_OPENWEATHERMAP_API_KEY
    # Optional: API endpoint (defaults to official API)
    # api_url: "https://api.openweathermap.org/data/2.5"
  
  # Open-Meteo settings (no API key required)
  # Open-Meteo is free and doesn't require an API key
  open_meteo:
    # Optional: API endpoint (defaults to official API)
    # api_url: "https://api.open-meteo.com/v1"
  
  # Weather Resilience & Caching Configuration
  # Provides reliable operation during temporary internet/API outages
  resilience:
    # Path to weather cache file (stores last successful forecast)
    cache_file: "state/weather_cache.json"  # ENV: HEATTRAX_WEATHER_CACHE_FILE
    
    # How long cached data is trusted for decision-making (in hours)
    # During an outage, cached data within this horizon will be used
    # After this time, system reverts to static schedule
    cache_valid_hours: 6.0  # ENV: HEATTRAX_WEATHER_CACHE_VALID_HOURS
    
    # How many hours of forecast to store in cache (should be >= cache_valid_hours)
    forecast_horizon_hours: 12  # ENV: HEATTRAX_WEATHER_FORECAST_HORIZON_HOURS
    
    # Normal polling interval when service is online (in minutes)
    refresh_interval_minutes: 10  # ENV: HEATTRAX_WEATHER_REFRESH_INTERVAL_MINUTES
    
    # Initial retry delay after a failure (in minutes)
    retry_interval_minutes: 5  # ENV: HEATTRAX_WEATHER_RETRY_INTERVAL_MINUTES
    
    # Maximum backoff interval for retries (in minutes)
    # Uses exponential backoff: 5min, 10min, 20min, 40min, up to this max
    max_retry_interval_minutes: 60  # ENV: HEATTRAX_WEATHER_MAX_RETRY_INTERVAL_MINUTES
    
    # How long service can be offline before triggering an alert (in minutes)
    outage_alert_after_minutes: 30  # ENV: HEATTRAX_WEATHER_OUTAGE_ALERT_AFTER_MINUTES

# Device Configuration
# Multi-device mode with groups for organizing devices by function

# Global credentials for all Kasa/Tapo devices
# These credentials apply to all devices configured in the groups below
devices:
  # Global credentials for all Kasa/Tapo devices
  credentials:
    username: "your_tapo_username"   # ENV: HEATTRAX_TAPO_USERNAME
    password: "your_tapo_password"   # ENV: HEATTRAX_TAPO_PASSWORD
  
  # Device groups - organize devices by function
  groups:
    # Heated mats group - controlled by weather automation
    heated_mats:
      enabled: true
      # Automation rules for this group
      automation:
        # Weather-based control
        weather_control: true
        # Turn on before precipitation
        precipitation_control: true
        # Early morning black ice protection
        morning_mode: true
      
      # Devices in this group
      items:
        - name: "Front Walkway Mat"
          ip_address: "192.168.1.100"
          # For EP40M with 2 outlets, specify which outlets to control
          # If omitted, controls the entire plug
          outlets: [0, 1]  # Control both outlets
        
        - name: "Driveway Mat"
          ip_address: "192.168.1.101"
          outlets: [0]  # Control only first outlet
        
        - name: "Back Porch Mat"
          ip_address: "192.168.1.102"
          # No outlets specified = control entire device
    
    # Christmas lights group - schedule-based control
    christmas_lights:
      enabled: true
      # Automation rules for this group
      automation:
        # Weather-based control disabled for lights
        weather_control: false
        precipitation_control: false
        morning_mode: false
        # Schedule-based control
        schedule_control: true
      
      # Schedule for this group
      schedule:
        # Turn on at sunset or specific time
        on_time: "17:00"  # 5:00 PM
        # Turn off at specific time
        off_time: "23:00"  # 11:00 PM
        # Optional: Only run on specific days (0=Monday, 6=Sunday)
        # days: [5, 6]  # Saturday and Sunday only
      
      # Devices in this group
      items:
        - name: "Front Yard Lights"
          ip_address: "192.168.1.110"
          outlets: [0, 1]
        
        - name: "Tree Lights"
          ip_address: "192.168.1.111"

# Weather thresholds for heated mats
# Environment variables: HEATTRAX_THRESHOLD_TEMP_F, HEATTRAX_LEAD_TIME_MINUTES, HEATTRAX_TRAILING_TIME_MINUTES
thresholds:
  # Temperature threshold in Fahrenheit for icy conditions
  temperature_f: 34              # ENV: HEATTRAX_THRESHOLD_TEMP_F
  # Minutes before precipitation to turn on (anticipatory heating)
  lead_time_minutes: 60          # ENV: HEATTRAX_LEAD_TIME_MINUTES
  # Minutes after precipitation ends to keep heating (ensure drying)
  trailing_time_minutes: 60      # ENV: HEATTRAX_TRAILING_TIME_MINUTES

# Optional morning frost-clearing/black ice protection mode
# Environment variables: HEATTRAX_MORNING_MODE_ENABLED, HEATTRAX_MORNING_MODE_START_HOUR, HEATTRAX_MORNING_MODE_END_HOUR
morning_mode:
  enabled: true      # ENV: HEATTRAX_MORNING_MODE_ENABLED (true/false)
  start_hour: 6      # ENV: HEATTRAX_MORNING_MODE_START_HOUR (0-23)
  end_hour: 8        # ENV: HEATTRAX_MORNING_MODE_END_HOUR (0-23)
  # Temperature threshold for morning mode (can be different from main threshold)
  temperature_f: 32  # Activate if below this temp during morning window

# Safety settings
# Environment variables: HEATTRAX_MAX_RUNTIME_HOURS, HEATTRAX_COOLDOWN_MINUTES
safety:
  # Maximum continuous runtime in hours
  max_runtime_hours: 6       # ENV: HEATTRAX_MAX_RUNTIME_HOURS
  # Cooldown period after max runtime in minutes
  cooldown_minutes: 30       # ENV: HEATTRAX_COOLDOWN_MINUTES

# Scheduler settings
# Environment variables: HEATTRAX_CHECK_INTERVAL_MINUTES, HEATTRAX_FORECAST_HOURS
scheduler:
  # How often to check weather in minutes
  check_interval_minutes: 10   # ENV: HEATTRAX_CHECK_INTERVAL_MINUTES
  # How far ahead to look for precipitation in hours
  forecast_hours: 12           # ENV: HEATTRAX_FORECAST_HOURS

# Logging settings
# Environment variable: HEATTRAX_LOG_LEVEL
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL - ENV: HEATTRAX_LOG_LEVEL
  max_file_size_mb: 10
  backup_count: 5

# Health check settings - periodic device monitoring
# Environment variables: HEATTRAX_HEALTH_CHECK_INTERVAL_HOURS, HEATTRAX_HEALTH_CHECK_MAX_FAILURES
health_check:
  interval_hours: 24  # How often to run health checks (ENV: HEATTRAX_HEALTH_CHECK_INTERVAL_HOURS)
  max_consecutive_failures: 3  # Max failures before triggering re-init (ENV: HEATTRAX_HEALTH_CHECK_MAX_FAILURES)

# Reboot settings - pause before container restart
# Environment variable: HEATTRAX_REBOOT_PAUSE_SECONDS
reboot:
  pause_seconds: 60  # Pause duration (in seconds) before container restart on critical failures (ENV: HEATTRAX_REBOOT_PAUSE_SECONDS)
                     # This allows time for console troubleshooting before automatic restart
                     # Set to 0 to disable the pause

# Health check HTTP server settings
# Environment variables: HEATTRAX_HEALTH_SERVER_*
health_server:
  enabled: true  # ENV: HEATTRAX_HEALTH_SERVER_ENABLED (true/false)
                 # Enable HTTP server for health check endpoints
  host: "0.0.0.0"  # ENV: HEATTRAX_HEALTH_SERVER_HOST
                   # Host to bind to (0.0.0.0 for all interfaces)
  port: 8080  # ENV: HEATTRAX_HEALTH_SERVER_PORT
              # Port for health check endpoints
              # Endpoints:
              #   - GET /health - Basic application health
              #   - GET /health/weather - Weather-specific health check

# Notification settings - alerts for device issues (default: all disabled)
# Email notifications - Environment variables: HEATTRAX_NOTIFICATION_EMAIL_*
notifications:
  # Global notification settings
  required: false  # ENV: HEATTRAX_NOTIFICATIONS_REQUIRED (true/false)
                   # If true, misconfigured enabled providers cause startup failure
                   # If false (default), log errors but allow startup to continue
  
  test_on_startup: false  # ENV: HEATTRAX_NOTIFICATIONS_TEST_ON_STARTUP (true/false)
                          # If true, send test notification on successful startup
  
  # Email provider configuration
  email:
    enabled: false  # ENV: HEATTRAX_NOTIFICATION_EMAIL_ENABLED (true/false)
    smtp_host: "smtp.gmail.com"  # ENV: HEATTRAX_NOTIFICATION_EMAIL_SMTP_HOST
    smtp_port: 587  # ENV: HEATTRAX_NOTIFICATION_EMAIL_SMTP_PORT
    smtp_username: "your_email@gmail.com"  # ENV: HEATTRAX_NOTIFICATION_EMAIL_SMTP_USERNAME
    smtp_password: "your_app_password"  # ENV: HEATTRAX_NOTIFICATION_EMAIL_SMTP_PASSWORD
    from_email: "your_email@gmail.com"  # ENV: HEATTRAX_NOTIFICATION_EMAIL_FROM
    to_emails:  # ENV: HEATTRAX_NOTIFICATION_EMAIL_TO (comma-separated)
      - "recipient1@example.com"
      - "recipient2@example.com"
    use_tls: true  # ENV: HEATTRAX_NOTIFICATION_EMAIL_USE_TLS (true/false)
  
  # Webhook notifications - Environment variables: HEATTRAX_NOTIFICATION_WEBHOOK_*
  webhook:
    enabled: false  # ENV: HEATTRAX_NOTIFICATION_WEBHOOK_ENABLED (true/false)
    url: "https://your-webhook-url.com/notifications"  # ENV: HEATTRAX_NOTIFICATION_WEBHOOK_URL
    # Optional custom headers can be added here
  
  # Forecast summary notifications (optional, default: disabled)
  # Sends human-friendly forecast summaries via email/webhook after successful weather fetch
  forecast:
    enabled: false  # ENV: HEATTRAX_NOTIFICATION_FORECAST_ENABLED (true/false)
    # Notification mode:
    #   - "always": Send on every successful forecast fetch (default)
    #   - "on_change": Only send when forecast changes meaningfully
    notify_mode: "always"  # ENV: HEATTRAX_NOTIFICATION_FORECAST_NOTIFY_MODE
    # Thresholds for detecting "meaningful" changes (used when notify_mode=on_change)
    temp_change_threshold_f: 5.0  # Significant temperature change (Â°F)
    precip_change_threshold_mm: 2.0  # Significant precipitation change (mm)
    # Path to state file for tracking last sent forecast
    state_file: "state/forecast_notification_state.json"
  
  # Per-event routing configuration (optional)
  # If not specified, all events go to all enabled providers (default behavior)
  # Use this to control which events go to which providers
  # routing:
  #   device_lost:           # Device not found during health check
  #     email: true
  #     webhook: true
  #   device_found:          # New device discovered
  #     email: false
  #     webhook: true
  #   device_ip_changed:     # Device IP address changed (critical)
  #     email: true
  #     webhook: true
  #   connectivity_lost:     # Failed to connect/reinitialize device
  #     email: true
  #     webhook: true
  #   connectivity_restored: # Device connection restored
  #     email: false
  #     webhook: true
  #   weather_service_recovered:  # Weather service came back online
  #     email: true
  #     webhook: true
  #   weather_service_offline:    # Weather service went offline
  #     email: true
  #     webhook: true
  #   forecast_summary:           # New forecast data (if forecast.enabled=true)
  #     email: true
  #     webhook: false

# Web UI Configuration
# Provides a browser-based interface for monitoring and configuration
web:
  enabled: true  # ENV: HEATTRAX_WEB_ENABLED (true/false)
                 # Enable or disable the web UI
  
  bind_host: "127.0.0.1"  # Host to bind to (default: localhost only)
                          # Use "0.0.0.0" to allow network access (see security warning)
                          # SECURITY WARNING: Do not bind to 0.0.0.0 without enabling authentication
  
  port: 4328  # Port for web UI (default: 4328)
              # Access the UI at http://<bind_host>:<port>
  
  # Authentication settings (for future use)
  auth:
    enabled: false  # Enable authentication (default: false)
                    # When false, UI is accessible without password
                    # SECURITY: Only disable auth if web UI is bound to 127.0.0.1
    
    username: "admin"  # Username for web UI login (default: admin)
    
    password_hash: ""  # Hashed password for web UI
                       # Set via HEATTRAX_WEB_PASSWORD environment variable
                       # Leave empty to disable authentication

# Additional environment variables:
# - HEATTRAX_CONFIG_PATH: Path to this configuration file (default: /app/config.yaml)
# - HEATTRAX_WEB_ENABLED: Enable/disable web UI (default: true)
# - HEATTRAX_WEB_PASSWORD: Set web UI password (hashed and stored in config)
# - TZ: System timezone (e.g., America/New_York)

# Notification Events:
# - device_lost: Configured device not found during health check
# - device_found: New device discovered
# - device_changed: Device alias or properties changed
# - device_ip_changed: Device MAC/IP mapping changed (critical)
# - connectivity_lost: Failed to reinitialize device connection
# - connectivity_restored: Device connection restored after failures
# - weather_service_recovered: Weather service came back online
# - weather_service_degraded: Weather service offline but using cached data
# - weather_service_offline: Weather service offline with no valid cache
# - weather_service_outage_alert: Weather service offline too long
# - forecast_summary: New forecast data fetched (human-friendly summary)
